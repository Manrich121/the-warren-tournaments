generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Point metrics that can be used in scoring formulas
enum PointMetricType {
  EVENT_ATTENDANCE
  MATCH_WINS
  GAME_WINS
  FIRST_PLACE // 1st place in event
  SECOND_PLACE // 2nd place in event
  THIRD_PLACE // 3rd place in event
}

// Tie-breaker metrics for ranking players with equal points
enum TieBreakerType {
  LEAGUE_POINTS
  MATCH_POINTS
  OPP_MATCH_WIN_PCT // Opponent Match Win Percentage
  GAME_WIN_PCT
  OPP_GAME_WIN_PCT // Opponent Game Win Percentage
  EVENT_ATTENDANCE_TIE // Event Attendance (when used as tie-breaker)
  MATCH_WINS_TIE // Match Wins (when used as tie-breaker)
}

model Player {
  id               String   @id @default(cuid())
  name             String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  matchesAsPlayer1 Match[]  @relation("Player1")
  matchesAsPlayer2 Match[]  @relation("Player2")
  events           Event[]  @relation("EventParticipants")
}

model Match {
  id           String   @id @default(cuid())
  eventId      String
  player1Id    String
  player2Id    String
  player1Score Int
  player2Score Int
  round        Int
  draw         Boolean
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  event        Event    @relation(fields: [eventId], references: [id])
  player1      Player   @relation("Player1", fields: [player1Id], references: [id])
  player2      Player   @relation("Player2", fields: [player2Id], references: [id])
}

model Event {
  id           String   @id @default(cuid())
  leagueId     String
  name         String
  date         DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  league       League   @relation(fields: [leagueId], references: [id])
  matches      Match[]
  participants Player[] @relation("EventParticipants")
}

model League {
  id              String         @id @default(cuid())
  name            String
  startDate       DateTime
  endDate         DateTime
  scoringSystemId String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  events          Event[]
  prizePool       PrizePool[]
  scoringSystem   ScoringSystem? @relation(fields: [scoringSystemId], references: [id], onDelete: SetNull)

  @@index([scoringSystemId])
}

model Admin {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PrizePool {
  id        String   @id @default(cuid())
  leagueId  String
  amount    Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  league    League   @relation(fields: [leagueId], references: [id])
}

// Scoring System - defines how points are calculated and players ranked
model ScoringSystem {
  id          String         @id @default(cuid())
  name        String         @unique
  isDefault   Boolean        @default(false)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  formulas    ScoreFormula[]
  tieBreakers TieBreaker[]
  leagues     League[]

  @@index([isDefault])
}

// Score Formula - individual point calculation rule (N x PointMetric)
model ScoreFormula {
  id              String          @id @default(cuid())
  scoringSystemId String
  multiplier      Int
  pointMetric     PointMetricType
  order           Int
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  scoringSystem   ScoringSystem   @relation(fields: [scoringSystemId], references: [id], onDelete: Cascade)

  @@index([scoringSystemId])
  @@index([scoringSystemId, order])
}

// Tie-Breaker - defines ranking criteria when players have equal points
model TieBreaker {
  id              String         @id @default(cuid())
  scoringSystemId String
  type            TieBreakerType
  order           Int
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  scoringSystem   ScoringSystem  @relation(fields: [scoringSystemId], references: [id], onDelete: Cascade)

  @@unique([scoringSystemId, order])
  @@index([scoringSystemId])
}
